name: Build Flatpak

on:
  push:
    tags:
      - v*
    branches: [master, dev, ci]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [master]
  workflow_dispatch:
    inputs:
      upload_to_release:
        description: '上传到 Release'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build-flatpak:
    name: Build Flatpak Package
    runs-on: ubuntu-latest
    outputs:
      build-success: ${{ steps.build-result.outputs.success }}
    container:
      image: bilelmoussaoui/flatpak-github-actions:freedesktop-23.08
      options: --privileged
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.15.0'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
      
      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT
      
      - name: Setup pnpm cache
        uses: actions/cache@v3
        continue-on-error: true
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install system dependencies
        run: |
          # Flatpak 构建容器基于 Fedora，使用 dnf
          # 安装构建所需的系统工具
          dnf install -y wget nodejs npm perl-Image-ExifTool p7zip p7zip-plugins
      
      - name: Install asar globally
        run: |
          # asar 不是系统包，需要通过 npm 安装
          npm install -g @electron/asar
      
      - name: Install Node.js dependencies
        run: |
          corepack enable
          pnpm install
      
      - name: Generate TAG
        id: tag
        run: |
          tag='continuous'
          name='Continuous Build'
          if [ 'true' == ${{ startsWith(github.ref, 'refs/tags/') }} ];then
            tag='${{ github.ref_name }}'
            name='${{ github.ref_name }}'
          fi
          echo "tag result: $tag - $name"
          echo "tag=$tag" >> $GITHUB_OUTPUT
          echo "name=$name" >> $GITHUB_OUTPUT
      
      - name: Build application resources
        run: |
          mkdir -p app
          tools/update-bilibili
          tools/fix-other.sh
          tools/extension.sh
          mv tmp/bili/resources/* app
      
      - name: Build project
        run: |
          pnpm build
      
      - name: Prepare Flatpak build
        run: |
          mkdir -p flatpak-build
          # 确保必要的文件存在
          if [ ! -d "app" ]; then
            echo "错误: app 目录不存在"
            exit 1
          fi
          if [ ! -d "bin" ]; then
            echo "错误: bin 目录不存在"
            exit 1
          fi
          # Flatpak 使用 BaseApp 提供的 electron，只需打包 bin 和 app
          tar -czf flatpak-build/bilibili-asar.tar.gz bin app
          cp io.github.msojocs.bilibili.yml flatpak-build/
          cp io.github.msojocs.bilibili.metainfo.xml flatpak-build/
          cp -r res flatpak-build/
      
      - name: Build Flatpak
        id: build-flatpak
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        continue-on-error: true
        with:
          bundle: io.github.msojocs.bilibili-${{ steps.tag.outputs.tag }}.flatpak
          manifest-path: flatpak-build/io.github.msojocs.bilibili.yml
          cache-key: flatpak-builder-${{ github.sha }}
          restore-cache: true
      
      - name: Generate flatpakref
        if: steps.build-flatpak.outcome == 'success'
        run: |
          cat > io.github.msojocs.bilibili.flatpakref <<EOF
          [Flatpak Ref]
          Name=io.github.msojocs.bilibili
          Branch=stable
          Title=哔哩哔哩
          IsRuntime=false
          Url=https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/io.github.msojocs.bilibili-${{ steps.tag.outputs.tag }}.flatpak
          RuntimeRepo=https://flathub.org/repo/flathub.flatpakrepo
          EOF
      
      - name: Upload Flatpak artifact
        if: steps.build-flatpak.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-bundle-${{ steps.tag.outputs.tag }}
          path: |
            *.flatpak
            *.flatpakref
          retention-days: 30
      
      - name: Create Flathub repository structure
        if: steps.build-flatpak.outcome == 'success' && startsWith(github.ref, 'refs/tags/')
        run: |
          mkdir -p flathub-repo
          cp flatpak-build/io.github.msojocs.bilibili.yml flathub-repo/
          cp flatpak-build/io.github.msojocs.bilibili.metainfo.xml flathub-repo/
          
          cat > flathub-repo/flathub.json <<EOF
          {
            "only-arches": ["x86_64", "aarch64"]
          }
          EOF
          
          cat > flathub-repo/README.md <<EOF
          # Bilibili Linux Client - Flathub

          This repository contains the Flatpak manifest for the Bilibili Linux client.

          ## Build
          \`\`\`bash
          flatpak-builder --force-clean build-dir io.github.msojocs.bilibili.yml
          \`\`\`

          ## Install
          \`\`\`bash
          flatpak-builder --user --install --force-clean build-dir io.github.msojocs.bilibili.yml
          \`\`\`

          ## Run
          \`\`\`bash
          flatpak run io.github.msojocs.bilibili
          \`\`\`
          EOF
      
      - name: Upload Flathub repository structure
        if: steps.build-flatpak.outcome == 'success' && startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: flathub-repo-structure
          path: flathub-repo/
          retention-days: 90
      
      - name: Report build status
        if: always()
        run: |
          if [ "${{ steps.build-flatpak.outcome }}" == "success" ]; then
            echo "Flatpak 构建成功"
          else
            echo "Flatpak 构建失败，已跳过上传步骤"
          fi
      
      - name: Set build result output
        id: build-result
        if: always()
        run: |
          if [ "${{ steps.build-flatpak.outcome }}" == "success" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi
  
  upload-flatpak:
    name: Upload Flatpak to Release
    needs: build-flatpak
    runs-on: ubuntu-latest
    if: |
      always() && 
      needs.build-flatpak.outputs.build-success == 'true' &&
      (startsWith(github.ref, 'refs/tags/') || github.event.inputs.upload_to_release == 'true')
    
    steps:
      - name: Generate TAG
        id: tag
        run: |
          if [ 'true' == ${{ startsWith(github.ref, 'refs/tags/') }} ];then
            tag='${{ github.ref_name }}'
          else
            tag='continuous'
          fi
          echo "tag=$tag" >> $GITHUB_OUTPUT
      
      - name: Download Flatpak artifacts
        uses: actions/download-artifact@v4
        with:
          name: flatpak-bundle-${{ steps.tag.outputs.tag }}
          path: flatpak-artifacts
      
      - name: List artifacts
        run: |
          ls -lah flatpak-artifacts/
      
      - name: Release Flatpak
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            flatpak-artifacts/*.flatpak
            flatpak-artifacts/*.flatpakref
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
